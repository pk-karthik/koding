files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/01init-ebenvname.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/sh
      cat /opt/elasticbeanstalk/deploy/configuration/containerconfiguration | jq -r '.optionsettings["aws:elasticbeanstalk:application:environment"][0]' | awk -F '=' '{print $2}' > /var/app/current/EB_ENV_NAME
      echo $EB_ENV_NAME-$(/opt/aws/bin/ec2-metadata --instance-id | awk '{print $2}') > /etc/hostname
      hostname -F /etc/hostname


  "/opt/elasticbeanstalk/hooks/appdeploy/post/01init-register-to-papertrail.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      cd /var/app/current

      PAPERTRAIL_URL="https://papertrailapp.com/api/v1/systems"
      PAPERTRAIL_PORT=`cat PAPERTRAIL_PORT`
      PAPERTRAIL_TOKEN=`cat PAPERTRAIL_TOKEN`

      # AWS stores environment vars added via ui in this file. `EB_ENV_NAME` refers to the current
      # elasticbeanstalk environment name. It's in format of `koding-<name>`, ie `koding-latest`.
      EB_ENV_NAME=`grep -oP 'EB_ENV_NAME=koding-\K([A-Za-z0-9]*)' /opt/elasticbeanstalk/deploy/configuration/containerconfiguration`
      PUBLIC_IP=`/opt/aws/bin/ec2-metadata -v | awk '{print $2}'`
      PAPERTRAIL_HOST=$EB_ENV_NAME-$PUBLIC_IP

      curl -0 -v -X POST $PAPERTRAIL_URL -H "X-Papertrail-Token: $PAPERTRAIL_TOKEN"  \
      --data "destination_port=${PAPERTRAIL_PORT}&system[name]=${PAPERTRAIL_HOST}&system[hostname]=${PAPERTRAIL_HOST}"


  "/opt/elasticbeanstalk/hooks/appdeploy/post/01init.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/sh
      export HOME=/home/ec2-user
      source /etc/profile

      ln -sf /var/app/current /opt/koding
      cd /var/app/current

      chown -R webapp:webapp /var/app/current

      cp .env.sh /etc/profile.d/koding.sh

      echo "setting ulimit"
      ulimit -n 10000

      npm install --unsafe-perm --production
      ./run exec go/build.sh


  "/opt/elasticbeanstalk/hooks/appdeploy/post/01or.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/sh
      EB_ENV_NAME=`cat /var/app/current/EB_ENV_NAME`
      if [ "$EB_ENV_NAME" != "koding-sandbox" ]; then
        /opt/koding/scripts/add_public_ip_to_objectrocket.sh
      fi


  "/opt/elasticbeanstalk/hooks/appdeploy/post/02init.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/sh
      service supervisord stop
      cp /var/app/current/deployment/generated_files/supervisord.conf /etc/supervisord.conf
      cp /var/app/current/.env.sh /etc/sysconfig/supervisord
      ulimit -n 65535
      service supervisord restart


  "/opt/elasticbeanstalk/hooks/appdeploy/post/03init.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/sh
      echo 'koding:$apr1$K17a7D.N$vuaxDfc4kJvHAg7Id43wk1' > /etc/nginx/conf.d/.htpasswd
      echo 'USER3489:$apr1$52wVqnxi$eVUrgOn8oRfPQRG8vU8jE0' >> /etc/nginx/conf.d/.htpasswd
      service nginx restart


  "/opt/elasticbeanstalk/hooks/appdeploy/post/04env.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/sh
      service remote_syslog stop
      sleep 3
      service remote_syslog start


  "/opt/elasticbeanstalk/hooks/appdeploy/post/07_cleanup.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      rm -rf /tmp/npm*
